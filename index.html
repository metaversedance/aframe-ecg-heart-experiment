
<html>
  <head>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/tizzle/aframe-orbit-controls-component/v0.1.13/dist/aframe-orbit-controls-component.min.js"></script>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,maximum-scale=1">
    <title>Examples â€¢ Animation</title>
    <script src="aframe-extras.js"></script>
    <script src="ecgData.js"></script>
    <script type="text/javascript">
      AFRAME.registerComponent("offset-texture-animation", {
        //Anything in schema can be changed in the visual inspector! CTRL+ATL+i 
        schema: {
          "heart-texture": {"type":"string"},
          "offset-scale": {default: 0.03}
        },
        init: function(){
          var self = this;
          //Load tree-veins texture to be used on mesh & animated via offset
          this.texLoader = new THREE.TextureLoader();//
          // this.heartTex = this.texLoader.load(this.data["heart-texture"]);
          this.heartTex = this.texLoader.load("textures/tree-veins.jpg");

          //create new THREE.js material. Important to set morphTargets to true!
          this.material = new THREE.MeshLambertMaterial({morphTargets: true, map: this.heartTex});

          this.el.addEventListener("model-loaded", function(e){
            console.log(e)
            console.log(self.material)
            e.detail.model.material = self.material;
          })

        }, //tick function called on each frame, 
            //arguments: time since initialization, time since last tick
        tick: function(time,delta) {
          if(!this.el.object3D.children[0]) return;
          //Create a sin wave from time, scaled by offset-scale
          // var offset = Math.sin(time) * this.data["offset-scale"];
          var offset = Math.sin(time/3000)/10;

          //offset texture x & y
          this.el.object3D.children[0].material.map.offset.y = offset;
          this.el.object3D.children[0].material.map.offset.x = offset;

        },
        update: function(oldData) {
          if(oldData["heart-texture"] !== this.data["heart-texture"]) {
            this.heartTex = this.texLoader.load(this.data["heart-texture"]);
          }


        }

      })

      AFRAME.registerComponent("heart-pump-animation",{
        schema: {
          heartPumpScalar: {type:"number", default:2},
          heartFragmentMorphScalar: {type: "number", default: 0},
          // entityToTrack: {type: "string"},

        },
        init: function() {
          this.slider = document.getElementById("heart-slider");
          // this.getSpeed = function(deltaTime,currentPosition, lastPosition) {
          //     var deltaX = lastPosition.x - currentPosition.x ;
          //     var deltaY =  lastPosition.y - currentPosition.y ;
          //     var deltaZ = lastPosition.z - currentPosition.z;
          //     var distanceTravelled =  Math.sqrt( deltaX*deltaX + deltaY*deltaY + deltaZ*deltaZ)
          //     var speed = distanceTravelled / deltaTime;
          //     return speed;

          // }
          // this.entityToTrack = this.el.sceneEl.querySelector(this.data.entityToTrack);
          // this.lastObjPosition = this.entityToTrack.getAttribute("position");


          this.ecgData = window.ecgData;
          console.log("this.el.object3d",this.el.object3D)
          this.ecgArrIdx = 0;
          this.timeCounter = 0;

        },
        tick: function(time,deltaTime) {
          this.timeCounter+=deltaTime;
          // console.log(this.timeCounter)
          if(this.timeCounter > 1) {
            this.timeCounter = 0;
            this.ecgArrIdx++;
          }
          if(this.ecgArrIdx === this.ecgData.length) {
            this.ecgArrIdx = 0;
          }


          if(this.el.object3D.children[0])  {
            // var currentObjPosition =  this.entityToTrack.getAttribute("position");
            // var speed = this.getSpeed(deltaTime, currentObjPosition, this.lastObjPosition)

            var heartPumpScalar =  this.data.heartPumpScalar;
            var heartFragmentMorphValue = this.data.heartFragmentMorphValue;
            this.el.object3D.children[0].morphTargetInfluences[1] = this.ecgData[this.ecgArrIdx]*heartPumpScalar;
            // this.el.object3D.children[0].morphTargetInfluences[3] = parseFloat(this.slider.value/10)
                this.el.object3D.children[0].morphTargetInfluences[2] = parseFloat(this.slider.value/100)


            // this.lastObjPosition = currentObjPosition;



          }
        }
      })
    </script>
  </head>
  <body>
    
    <input type="range" id="heart-slider" value="0" max="100" min="0" style="z-index: 1; position:relative; float: right">
    <button id="wireframe-bttn" style="position: relative; z-index:1 ; float: right">wireframe</button>

    <script>
  //toggles wireframe of heart
    var wireframeBttn = document.getElementById("wireframe-bttn")

    wireframeBttn.addEventListener("click", function(){
      document.getElementById("heart").object3D.children[0].material.materials.forEach(function(material){
        var wireframeBool = material.wireframe = !material.wireframe;

        wireframeBttn.innerText = "wireframe: " + wireframeBool;
      })
    })
  </script>
  <script type="text/javascript">
    
  </script>
    <a-scene>
    <a-assets>
      <img id="tree-veins" src="textures/tree-veins.jpg">
      <a-asset-item id="heart-model" src="heart_morph2.json"></a-asset-item>
    </a-assets>
      <!-- Player -->
      <a-entity id="camera"
                camera="userHeight: 1.6"
                universal-controls
                position="0 1 0"
                position="0 0 5"
                orbit-controls="
                  autoRotate: true;
                  target: #heart;
                  enableDamping: true;
                  dampingFactor: 1;
                  rotateSpeed:0.01;
                  minDistance:.1;
                  maxDistance:100;
                  "
                mouse-cursor=""
                >
      </a-entity>

<!--       <a-entity id="camera"
                universal-controls
                camera="userHeight: 1.6"
                universal-controls
                position="0 2 12"
                mouse-cursor=""
                >
      </a-entity> -->

      <!-- Animation
           See: http://threejs.org/examples/#webgl_animation_scene
      -->
      <a-entity id="heart" 
                offset-texture-animation="heart-texture:textures/tree-veins.jpg"

                rotation="-48.530 173.950 -42.170"
                json-model="src:bloom_texture_mapped.json"
                position="0 2 0"
                scale="3 3 3"
                heart-pump-animation="heartPumpScalar:6.450;heartFragmentMorphValue: 1;">
      </a-entity>



<!--       <a-entity 
          json-model="src:#heart-model"
          position="1 3 4"
          scale="2 10 5"
          heart-pump-animation="heartPumpScalar:10;heartFragmentMorphValue: 1;">
      </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="-4 6.7 1.2"
          scale="1 1 1"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;">
      </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="-9 5 -1"
          scale=".5 2 7"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;">
     </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="0 2 0"
          scale="1 1 1"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;"> 
     </a-entity> -->


      <!-- Lighting -->
      <a-light type="ambient" color="#bbb"></a-light>
      <a-light color="#ccc" position="0 30 0" distance="100" intensity="0.4" type="point"></a-light>
      <a-light color="#ccc" position="3 10 -10" distance="50" intensity="0.4" type="point"></a-light>
      <a-sky color="black"></a-sky>
    </a-scene>
  </body>
</html>