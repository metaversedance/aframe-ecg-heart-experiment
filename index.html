
<html>
  <head>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/tizzle/aframe-orbit-controls-component/v0.1.13/dist/aframe-orbit-controls-component.min.js"></script>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,maximum-scale=1">
    <title>Examples â€¢ Animation</title>
    <script src="aframe-extras.js"></script>
    <script src="ecgData.js"></script>
    <script type="text/javascript">
// AFRAME.registerComponent("scale-to-entity-speed",{
//     schema: {
//         entityToTrack: { type: "string"},
//         partToScale: {type: "string"}
//     },
//     init: function() {
//         this.objectToFollow = this.el.sceneEl.querySelector(this.data.entityToTrack);
//         this.speed = 0;
//         this.lastObjPosition = this.el.getAttribute("position");
//         this.getSpeed = function(deltaTime,currentPosition, lastPosition) {
//             var deltaX = lastPosition.x - currentPosition.x ;
//             var deltaY =  lastPosition.y - currentPosition.y ;
//             var deltaZ = lastPosition.z - currentPosition.z;
//             var distanceTravelled =  Math.sqrt( deltaX*deltaX + deltaY*deltaY + deltaZ*deltaZ)
//             var speed = distanceTravelled / deltaTime;
//             return speed;

//         }
//         // forearm_L 7 forearm_R 26 dancer.object3D.children[0].geometry

//     },
//     tick: function(time,delta) {
//         if(this.objectToFollow && this.el.object3D.children[0]) {
//             var currentObjPosition =  this.objectToFollow.getAttribute("position");
//             var speed = this.getSpeed(delta, currentObjPosition, this.lastObjPosition)


//             this.lastObjPosition = currentObjPosition;

//         }

//     },
//     multiple: true

//  })

      AFRAME.registerComponent("heart-pump-animation",{
        schema: {
          heartPumpScalar: {type:"number", default:2},
          heartFragmentMorphScalar: {type: "number", default: 0},
          // entityToTrack: {type: "string"},

        },
        init: function() {
          this.slider = document.getElementById("heart-slider");
          // this.getSpeed = function(deltaTime,currentPosition, lastPosition) {
          //     var deltaX = lastPosition.x - currentPosition.x ;
          //     var deltaY =  lastPosition.y - currentPosition.y ;
          //     var deltaZ = lastPosition.z - currentPosition.z;
          //     var distanceTravelled =  Math.sqrt( deltaX*deltaX + deltaY*deltaY + deltaZ*deltaZ)
          //     var speed = distanceTravelled / deltaTime;
          //     return speed;

          // }
          // this.entityToTrack = this.el.sceneEl.querySelector(this.data.entityToTrack);
          // this.lastObjPosition = this.entityToTrack.getAttribute("position");


          this.ecgData = window.ecgData;
          console.log("this.el.object3d",this.el.object3D)
          this.ecgArrIdx = 0;
          this.timeCounter = 0;

        },
        tick: function(time,deltaTime) {
          this.timeCounter+=deltaTime;
          // console.log(this.timeCounter)
          if(this.timeCounter > 1) {
            this.timeCounter = 0;
            this.ecgArrIdx++;
          }
          if(this.ecgArrIdx === this.ecgData.length) {
            this.ecgArrIdx = 0;
          }


          if(this.el.object3D.children[0])  {
            // var currentObjPosition =  this.entityToTrack.getAttribute("position");
            // var speed = this.getSpeed(deltaTime, currentObjPosition, this.lastObjPosition)

            var heartPumpScalar =  this.data.heartPumpScalar;
            var heartFragmentMorphValue = this.data.heartFragmentMorphValue;
            this.el.object3D.children[0].morphTargetInfluences[1] = this.ecgData[this.ecgArrIdx]*heartPumpScalar;
            // this.el.object3D.children[0].morphTargetInfluences[3] = parseFloat(this.slider.value/10)
                this.el.object3D.children[0].morphTargetInfluences[2] = parseFloat(this.slider.value/100)


            // this.lastObjPosition = currentObjPosition;



          }
        }
      })
    </script>
  </head>
  <body>
    
    <input type="range" id="heart-slider" value="0" max="100" min="0" style="z-index: 1; position:relative; float: right">
    <button id="wireframe-bttn" style="position: relative; z-index:1 ; float: right">wireframe</button>

    <script>
  //toggles wireframe of heart
    var wireframeBttn = document.getElementById("wireframe-bttn")

    wireframeBttn.addEventListener("click", function(){
      document.getElementById("heart").object3D.children[0].material.materials.forEach(function(material){
        var wireframeBool = material.wireframe = !material.wireframe;

        wireframeBttn.innerText = "wireframe: " + wireframeBool;
      })
    })
  </script>
  <script type="text/javascript">
    
    var loader = new THREE.TextureLoader();
    loader.load("textures/tree-veins.jpg", function(tex){
      window.heartTex = tex;

    })
    // var material = new THREE.MeshLambertMaterial({morphTargets: true, map: heartTex})

  // var interval = setInterval(function(){
  //   var offset = Math.sin(clock.getElapsedTime())/10
  //   heart.object3D.children[0].material.map.offset.y = offset;
  //   heart.object3D.children[0].material.map.offset.x = offset;

  // },50)
  </script>
    <a-scene>
    <a-assets>
      <a-asset-item id="heart-model" src="heart_morph2.json"></a-asset-item>
    </a-assets>
      <!-- Player -->
<!--       <a-entity id="camera"
                camera="userHeight: 1.6"
                universal-controls
                position="0 0 5"
                orbit-controls="
                  autoRotate: false;
                  target: #heart;
                  enableDamping: true;
                  dampingFactor: 1;
                  rotateSpeed:0.01;
                  minDistance:.1;
                  maxDistance:100;
                  "
                mouse-cursor=""
                >
      </a-entity> -->

      <a-entity id="camera"
                camera="userHeight: 1.6"
                universal-controls
                position="0 2 12"
                mouse-cursor=""
                >
      </a-entity>

      <!-- Animation
           See: http://threejs.org/examples/#webgl_animation_scene
      -->
      <a-entity id="heart" 
                rotation="-48.530 173.950 -42.170"
                json-model="src:bloom_texture_mapped.json"
                position="0 2 0"
                scale="3 3 3"
                heart-pump-animation="heartPumpScalar:6.450;heartFragmentMorphValue: 1;">
      </a-entity>



<!--       <a-entity 
          json-model="src:#heart-model"
          position="1 3 4"
          scale="2 10 5"
          heart-pump-animation="heartPumpScalar:10;heartFragmentMorphValue: 1;">
      </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="-4 6.7 1.2"
          scale="1 1 1"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;">
      </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="-9 5 -1"
          scale=".5 2 7"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;">
     </a-entity>

    <a-entity 
          json-model="src:#heart-model"
          position="0 2 0"
          scale="1 1 1"
          heart-pump-animation="heartPumpScalar:3;heartFragmentMorphValue: 1;"> 
     </a-entity> -->


      <!-- Lighting -->
      <a-light type="ambient" color="#bbb"></a-light>
      <a-light color="#ccc" position="0 30 0" distance="100" intensity="0.4" type="point"></a-light>
      <a-light color="#ccc" position="3 10 -10" distance="50" intensity="0.4" type="point"></a-light>
      <a-sky color="black"></a-sky>
    </a-scene>
  </body>
</html>